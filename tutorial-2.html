<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tutorial, part 2 &mdash; Blueprint</title>
<style type="text/css">
html { text-align: center; }
body {
	font-size: 16px;
	margin: 0 auto;
	text-align: left;
	width: 80%;
}
body, h1, h2, h3, h4, h5, h6 { font-family: "Helvetica Neue", Helvetica, sans-serif; }
a, a:link, a:hover, a:active, a:visited { color: #0040c5; }
p, pre {
	margin: 1.5em 0;
	line-height: 1.5em;
}
h1 {
	margin: 1em 0;
	font-size: 1.5em;
	line-height: 1em;
}
h2 {
	margin: 1em 0;
	font-size: 1.25em;
	line-height: 1.2em;
}
ul, ol, dl {
	margin: 1.5em 0;
	padding: 0;
}
ul, ol { margin-left: 1.5em; }
li, dt, dd {
	margin: 0;
	font-size: 1em;
	line-height: 1.5em;
}
dd { margin: 0 0 0 1.5em; }
header { text-align: center; }
footer {
	background: url(logo.png) no-repeat center bottom;
	padding-bottom: 136px;
	margin-bottom: 1.5em;
	text-align: center;
}
</style>
</head>
<body>
<header>
	<h1>Blueprint</h1>
	<p>Reverse engineer server configuration</p>
</header>

<section>
	<h1>Tutorial, part 2 &mdash; your first blueprint</h1>
	<p>Use the tools you know and love like <code>apt-get</code>, <code>gem</code>, <code>yum</code> and <code>pip</code> to configure your server.&nbsp; When you're ready to deploy, <code>blueprint</code> generates code to recreate your environment on any hosting provider.</p>
	<p>In this part of the tutorial, we&#8217;ll create a very simple Sinatra web application on an Ubuntu server, but this workflow applies equally well to your favorite language, framework and distribution.</p>
	<h2>Install dependencies</h2>
	<pre><strong>sudo apt-get -y install ruby rubygems</strong>
<strong>sudo gem install --no-rdoc --no-ri sinatra</strong></pre>
	<p>Notice how you didn&#8217;t have to write any special code.</p>
	<h2>Hack</h2>
	<p><code>blueprint</code> isn&#8217;t here to tell you how to write web apps &mdash; that&#8217;s your expertise and we&#8217;re going to get you back to it as quickly as possible.&nbsp; &#8220;Hello, world,&#8221; in <a href="http://www.sinatrarb.com/">Sinatra</a> is but four lines of Ruby.</p>
	<pre># /var/www/app.rb
require 'sinatra'
get '/hi' do
&nbsp; "Hello World!"
end</pre>
	<p>With just that, you have a toy web app.</p>
	<pre>$ <strong>ruby -rrubygems app.rb</strong>
== Sinatra/1.1.2 has taken the stage on 4567 for development with backup from WEBrick
[2011-01-26 02:16:16] INFO  WEBrick 1.3.1
[2011-01-26 02:16:16] INFO  ruby 1.8.7 (2010-06-23) [i686-linux]
[2011-01-26 02:16:16] INFO  WEBrick::HTTPServer#start: pid=19772 port=4567</pre>
	<h2>Create your first blueprint</h2>
	<p>With your working app, run <code>blueprint create <em>tutorial</em></code>.&nbsp; We&#8217;re using the <code>-S</code> option to <a href="blueprint-create.1.html"><code>blueprint-create</code>(1)</a> to create a shell script from the blueprint.</p>
	<pre>$ <strong>blueprint create tutorial -S</strong>
# [blueprint-backend] searching for apt packages
# [blueprint-backend] searching for Ruby gems
# [blueprint-backend] searching for Python packages
# [blueprint-backend] searching for PEAR/PECL packages
# [blueprint-backend] searching for configuration files
# [blueprint-backend] searching for source installations in /usr/local
tutorial.sh
$ <strong>cat tutorial.sh</strong>
#
# Automatically generated by blueprint(7).  Edit at your own risk.
#
cd "$(dirname "$0")"
apt-get -q update
apt-get -y install ruby=4.5
apt-get -y install ruby1.8=1.8.7.299-2
apt-get -y install ruby1.8-dev=1.8.7.299-2
apt-get -y install rubygems1.8=1.3.7-2
gem1.8 install rack -v1.2.1
gem1.8 install sinatra -v1.1.2
gem1.8 install tilt -v1.2.2
$</pre>
	<h2>Production-ready</h2>
	<p>Running a script in an interactive terminal isn&#8217;t much of a production setup so let&#8217;s configure a real web server.&nbsp; We&#8217;re going to use Nginx and Unicorn but <code>blueprint</code> doesn&#8217;t care what you choose.</p>
	<pre><strong>sudo apt-get -y install nginx</strong>
<strong>sudo gem install --no-rdoc --no-ri unicorn</strong></pre>
	<p>First we&#8217;ll configure Nginx to proxy to Unicorn.</p>
	<pre># /etc/nginx/sites-available/tutorial
server {
	listen 80 default;
	location /static { root /var/www; }
	location / { proxy_pass http://127.0.0.1:8000; }
}</pre>
	<pre><strong>ln -s /etc/nginx/sites-{available,enabled}/tutorial</strong></pre>
	<p>Now we&#8217;ll configure Unicorn to serve our application and run via Upstart.</p>
	<pre># /var/www/config.ru
require 'app'
run Sinatra::Application</pre>
	<pre># /etc/init/tutorial.conf
description "DevStructure Tutorial"
start on runlevel [2345]
stop on runlevel [!2345]
respawn
chdir /var/www
exec unicorn</pre>
	<p>With everything configured, let&#8217;s restart servers and test.&nbsp; Visit <code>http://<em>your-server</em>/hi</code> to be greeted by Sinatra via Nginx.</p>
	<pre><strong>sudo start tutorial</strong>
<strong>sudo /etc/init.d/nginx reload</strong></pre>
	<p>This is a good approximation of a simple production setup that we&#8217;ve completely mocked in development.</p>
	<h2>Update your blueprint</h2>
	<p>After making these changes to your environment, run <code>blueprint create <em>tutorial</em> -S</code> again to create a new version of your blueprint that includes your production-ready configuration.</p>
	<pre>$ <strong>blueprint create tutorial -S</strong>
# [blueprint-backend] searching for apt packages
# [blueprint-backend] searching for Ruby gems
# [blueprint-backend] searching for Python packages
# [blueprint-backend] searching for PEAR/PECL packages
# [blueprint-backend] searching for configuration files
# [blueprint-backend] searching for source installations in /usr/local
tutorial.sh
$ <strong>cat tutorial.sh</strong>
#
# Automatically generated by blueprint(7).  Edit at your own risk.
#
cd "$(dirname "$0")"
mkdir -p /etc/init
cat &gt;/etc/init/tutorial.conf &lt;&lt;EOF
description "DevStructure Tutorial"
start on runlevel [2345]
stop on runlevel [!2345]
respawn
chdir /var/www
exec unicorn
EOF
chmod 0644 /etc/init/tutorial.conf
mkdir -p /etc/nginx/sites-available
cat &gt;/etc/nginx/sites-available/tutorial &lt;&lt;EOF
server {
	listen 80 default;
	location /static { root /var/www; }
	location / { proxy_pass http://127.0.0.1:8000; }
}
EOF
chmod 0644 /etc/nginx/sites-available/tutorial
mkdir -p /etc/nginx/sites-enabled
ln -s /etc/nginx/sites-available/tutorial /etc/nginx/sites-enabled/tutorial
apt-get -q update
apt-get -y install nginx=0.7.67-3ubuntu1
apt-get -y install ruby=4.5
apt-get -y install ruby1.8=1.8.7.299-2
apt-get -y install ruby1.8-dev=1.8.7.299-2
apt-get -y install rubygems1.8=1.3.7-2
gem1.8 install kgio -v2.1.1
gem1.8 install rack -v1.2.1
gem1.8 install sinatra -v1.1.2
gem1.8 install tilt -v1.2.2
gem1.8 install unicorn -v3.3.1
$</pre>
	<p>The new blueprint found our Nginx and Upstart configurations!</p>
</section>
<nav>
	<p>In <a href="tutorial-3.html">part 3</a> we&#8217;ll deploy to production.</p>
</nav>

<footer>
	<p>&copy; 2010 <a href="http://devstructure.com/">DevStructure</a>, LLC.&nbsp; <a href="https://github.com/devstructure/blueprint/blob/master/LICENSE"><code>LICENSE</code></a></p>
</footer>
</body>
</html>

