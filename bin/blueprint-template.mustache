#!/bin/sh

set -e

exec 3>&2

#/ Usage: blueprint template [-q] <pathname>
usage() {
	grep "^#/" "$0" | cut -c4- 1>&2
	exit 1
}
while [ "$#" -gt 0 ]
do
	case "$1" in
		-h|--help) usage;;
		-q|--quiet) exec 3>/dev/null;;
		*) break;;
	esac
done

# BEGIN mustache.sh
{{`cat mustache.sh/lib/mustache.sh`}}
# END mustache.sh

for PATHNAME in $(find "/etc/blueprint-template.d" -type f -name "*.sh")
do
	echo "# [blueprint-template] sourcing $PATHNAME" >&3
	. "$PATHNAME"
done

if [ -f "$1.blueprint-template.sh" ]
then
	echo "# [blueprint-template] sourcing $1.blueprint-template.sh" >&3
	. "$1.blueprint-template.sh"
fi

mustache <"$1.blueprint-template.mustache" >"$1"
